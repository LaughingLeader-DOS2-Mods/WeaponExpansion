Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_DoNotFace((CHARACTERGUID)S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a);
DB_Dialogs(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_VendingMachine_A");
DB_BlockThreatenedDialog(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a);
DB_NoLowAttitudeDialog(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a);
CharacterDisableAllCrimes(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a);
SetCanJoinCombat(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, 0);
CharacterSetImmortal(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, 1);
//DB_IsStoryNpc(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a);
//SetStoryNpc(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, 1);
SetTag(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LeaderLib_DisableTreasureTableLimit");
LLWEAPONEX_VendingMachine_RegisterTraderSettings();
LLWEAPONEX_VendingMachine_RegisterOrderMenu();

KBSECTION
//REGION SETTINGS_TRADER
PROC
LLWEAPONEX_VendingMachine_RegisterTraderSettings()
THEN
LeaderLib_Trader_Register_GlobalTrader("LLWEAPONEX.VendingMachine", S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a);
//LeaderLib_Trader_Register_Dialog("LLWEAPONEX.VendingMachine", "LLWEAPONEX_VendingMachine_A");

LeaderLib_Treasure_Register_TreasureToTrader("LLWEAPONEX.VendingMachine.Orders", "LLWEAPONEX.VendingMachine");
LeaderLib_Treasure_Register_TreasureToTrader("LLWEAPONEX.VendingMachine.Uniques", "LLWEAPONEX.VendingMachine");

LeaderLib_Treasure_Configure_DefaultGenerationType("LLWEAPONEX.VendingMachine.Uniques", "REQUIREMENT_UNLOCKED");
LeaderLib_Treasure_Configure_DefaultGenerationType("LLWEAPONEX.VendingMachine.Uniques", "TRADE_GENERATION_END");

LeaderLib_Treasure_Register_TreasureToTrader("LLWEAPONEX.VendingMachine.WorldUniques", "LLWEAPONEX.VendingMachine");
LeaderLib_Treasure_Configure_DefaultGenerationType("LLWEAPONEX.VendingMachine.WorldUniques", "REQUIREMENT_UNLOCKED");
LeaderLib_Treasure_Configure_DefaultGenerationType("LLWEAPONEX.VendingMachine.WorldUniques", "TRADE_GENERATION_END");
LeaderLib_Treasure_Configure_DefaultGenerationType("LLWEAPONEX.VendingMachine.WorldUniques", "REGISTERED");

LeaderLib_Requirements_Add_PartyLevelRequirement("LLWEAPONEX_Requirement_MinLevel_4", 4);
LeaderLib_Requirements_Add_ModRequirement("LLWEAPONEX_Requirement_MimicryModActive", "Mimicry", "LaughingLeader");

//Technically unique, but allow more than one to generate
LeaderLib_Treasure_Register_ItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "TOOL_Hammer_LLWEAPONEX_Runesmith_A_5a5e78fb-59ac-42b8-8e2f-d4d02f9217ec", 1, "LLWEAPONEX_Requirement_MinLevel_4");
LeaderLib_Treasure_Configure_AddMaxAmount("LLWEAPONEX.VendingMachine.Uniques", "TOOL_Hammer_LLWEAPONEX_Runesmith_A_5a5e78fb-59ac-42b8-8e2f-d4d02f9217ec", 1);

LLWEAPONEX_VendingMachine_RegisterUniqueWeapons();

//LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "EQ_UNIQUE_LLWEAPONEX_Blindfold_Monk_A_78b08f39-3d9d-47b5-b251-f1b8dcebe65b");
//LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "EQ_UNIQUE_LLWEAPONEX_Backpack_Demolition_A_8995798f-f5b6-4e71-ae84-a29ed4ca51d7");

LeaderLib_Trader_Register_Position("LLWEAPONEX.VendingMachine", "TestLevel_LL_WeaponExpansion", 40.56, 0.0, 29.63);
LeaderLib_Trader_Register_Rotation_Position("LLWEAPONEX.VendingMachine", "FJ_FortJoy_Main", 40.56, 0.0, 29.63);
//LeaderLib_Trader_Register_Position("LLWEAPONEX.VendingMachine", "TUT_Tutorial_A", 31.19, 4.0, -252.77);

//Dungeon Shrine in Fort Joy
LeaderLib_Trader_Register_Position("LLWEAPONEX.VendingMachine", "FJ_FortJoy_Main", 196.21, -3.98, 647.16);
LeaderLib_Trader_Register_Rotation_Position("LLWEAPONEX.VendingMachine", "FJ_FortJoy_Main", 204.38, -4.57, 649.32);

//Lady Vengeance 1st floor
LeaderLib_Trader_Register_Position("LLWEAPONEX.VendingMachine", "LV_HoE_Main", 336.39, 7.8, 577.70);
LeaderLib_Trader_Register_Rotation_Position("LLWEAPONEX.VendingMachine", "LV_HoE_Main", 336.39, 7.8, 579.0);

//Lady Vengeance 1st floor
LeaderLib_Trader_Register_Position("LLWEAPONEX.VendingMachine", "RC_Main", 740.56, 8.11, -41.46);
LeaderLib_Trader_Register_Rotation_Position("LLWEAPONEX.VendingMachine", "RC_Main", 740.56, 8.11, -40.22);

//Lady Vengeance 1st floor
LeaderLib_Trader_Register_Position("LLWEAPONEX.VendingMachine", "CoS_Main", 228.84, 16.09, 284.24);
LeaderLib_Trader_Register_Rotation_Position("LLWEAPONEX.VendingMachine", "CoS_Main", 226.68, 16.09, 284.24);

//Outside
LeaderLib_Trader_Register_Position("LLWEAPONEX.VendingMachine", "Arx_Main", 407.41, 39.19, 14.01);
LeaderLib_Trader_Register_Rotation_Position("LLWEAPONEX.VendingMachine", "Arx_Main", 409.22, 39.19, 13.19);

PROC
LLWEAPONEX_VendingMachine_RegisterUniqueWeapons()
THEN
LeaderLib_Requirements_Add_PartyLevelRequirement("LLWEAPONEX_LevelRequirement_Tier1", 3);
LeaderLib_Requirements_Add_PartyLevelRequirement("LLWEAPONEX_LevelRequirement_Tier2", 5);
LeaderLib_Requirements_Add_PartyLevelRequirement("LLWEAPONEX_LevelRequirement_Tier3", 9);
LeaderLib_Requirements_Add_PartyLevelRequirement("LLWEAPONEX_LevelRequirement_Tier4", 11);

//LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Firearm_Blunderbuss_2H_A_507801c0-4c6b-4b39-9aed-13fcd0962dd9");
//LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "EQ_UNIQUE_LLWEAPONEX_HandCrossbow_A_Ring_ad15f666-285d-4634-a832-ea643fa0a9d2");
////LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "LOOT_Rune_LLWEAPONEX_HandCrossbow_Bolts_Normal_baf9826a-abe8-4bc8-8c56-b68b5611c223");
//LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Quarterstaff_Spear_2H_PowerPole_3a40634d-b4c3-482a-9f24-c5e93b336d6a");

//LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Katana_Dagger_Sword_2H_Muramasa_4be8ec78-17ed-4f61-b3d8-96c260d1c80a");
//LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Katana_Dagger_Runeblade_Fire_1H_A_25726991-6bc1-45fb-a00b-d3bf855cd0d1", //"LLWEAPONEX_LevelRequirement_Tier1");
//LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Rapier_Dagger_Runeblade_Water_1H_d82bc239-4782-484c-88ab-e1fa571c9f6a");
//
//LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "EQ_UNIQUE_LLWEAPONEX_DemonGauntlet_Arms_A_f5d0a9b3-b83c-4b78-8bc6-a097a26ddf53", //"LLWEAPONEX_LevelRequirement_Tier1");
//LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Greatbow_Lightning_Bow_2H_A_7efec0e0-1c2e-4f0d-9ec5-e3a1f40c97b8");
//LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Sword_2H_Beholder_A_1cc2baa1-cd58-40a3-8b53-89ef2e081616", //"LLWEAPONEX_LevelRequirement_Tier1");
////Misc
//LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Wand_1H_MagicMissile_A_67ef34e7-5f50-4ef9-9e40-8c7c04884812");
//LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Scythe_2H_SoulHarvest_A_c308b26a-98d1-4429-8cce-4940f6eb5f69");
//LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Scythe_2H_DeathEdge_A_ca61e441-9446-40ac-811d-736327d4a0f0", //"LLWEAPONEX_LevelRequirement_Tier1");
//LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Spear_Halberd_2H_Warchief_A_93acdd5a-dc43-4cdc-90cf-560b310d5f08");
//LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "EQ_UNIQUE_LLWEAPONEX_ArmCannon_A_8a02d95d-dd91-4d97-9265-c3254923f9ee", //"LLWEAPONEX_LevelRequirement_Tier2");
//LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Staff_Banner_DivineOrder_A_ee686596-394f-44ae-867b-4596de1feedb");
//LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Staff_Banner_Dwarves_A_59675259-8e78-48fd-acad-cf70c90bc909", //"LLWEAPONEX_LevelRequirement_Tier1");
//LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Wraithblade_Sword_2H_A_ca59856d-6876-4f9c-8fe5-e086df193ca6");
//LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Runeblade_Chaos_Sword_2H_428c023d-a614-49cc-911d-499a6af4cbf5");
//LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_BattleBook_2H_Bible_B_d67c4ed3-4892-48e5-94fd-1cd966fe1f27");
//LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_BattleBook_2H_SpellScroll_A_f393c9d6-d90c-483f-be94-b47e9419395d");
//LeaderLib_Treasure_Register_UniqueItemTemplate("LLWEAPONEX.VendingMachine.Uniques", "WPN_UNIQUE_LLWEAPONEX_Anvil_Mace_2H_A_85e2e75e-4333-425e-adc4-94474c3fc201");
//END_REGION

//REGION UPDATES
/*
PROC
LeaderLib_Mods_OnVersionChanged(c60718c3-ba22-4702-9c5d-5ad92b41ba5f, (INTEGER)_LastVersion, (INTEGER)_NextVersion)
THEN
LLWEAPONEX_VendingMachine_RegisterUniqueWeapons();
*/

PROC
LeaderLib_Mods_OnVersionChanged(c60718c3-ba22-4702-9c5d-5ad92b41ba5f, (INTEGER)_LastVersion, (INTEGER)_NextVersion)
AND
DB_LLWEAPONEX_VendingMachine_SaleCooldown(-1, _CooldownTime)
THEN
DialogSetVariableString("LLWEAPONEX_VendingMachine_A", "LLWEAPONEX_VendingMachine_SaleStatus_b12f911c-7a98-4ff1-a35c-f2127335884f", "");
//END_REGION

//REGION SAFETY_CHECK_START
IF
SavegameLoaded(_,_,_,_)
AND
DB_GlobalFlag("LeaderLib_InitialEventFlowComplete")
AND
DB_CurrentLevel(_Level)
AND
ObjectExists(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _Exists)
THEN
LLWEAPONEX_VenchingMachine_Internal_RunSafetyCheck(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _Level, _Exists);

PROC
LLWEAPONEX_VenchingMachine_Internal_RunSafetyCheck((CHARACTERGUID)_VendingMachine, (STRING)_Level, 0)
THEN
LeaderLog_Log("DEBUG", "[LLWEAPONEX_01_VendingMachine:Internal:RunSafetyCheck] [ERROR] VendingMachine does not exist! How could this happen?!");
//END_REGION

//REGION DIALOG_SAFETY_CHECK
PROC
LLWEAPONEX_VenchingMachine_Internal_RunSafetyCheck((CHARACTERGUID)_VendingMachine, (STRING)_Level, (INTEGER)_Exists)
AND
NOT DB_Dialogs(_VendingMachine, _)
THEN
LeaderLog_Log("DEBUG", "[LLWEAPONEX_01_VendingMachine:Internal:RunSafetyCheck] [ERROR] VendingMachine has no dialog set in level [",_Level,"]! Setting to default.");
LeaderLib_Traders_SetDialogToFirstAvailable(_VendingMachine, "LLWEAPONEX.VendingMachine", _Level);
ProcObjectTimer(_VendingMachine, "LLWEAPONEX_Timers_CheckVendingMachineDialog", 500);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_VendingMachine, "LLWEAPONEX_Timers_CheckVendingMachineDialog")
AND
NOT DB_Dialogs(_VendingMachine, _)
THEN
LeaderLog_Log("DEBUG", "[LLWEAPONEX_01_VendingMachine:LLWEAPONEX_Timers_CheckVendingMachineDialog] [ERROR] VendingMachine was unable to set dialog via [LeaderLib_Traders_SetDialogToFirstAvailable]. Setting to [LLWEAPONEX_VendingMachine_A].");
DB_Dialogs(_VendingMachine, "LLWEAPONEX_VendingMachine_A");
//END_REGION

//REGION SPAWN_SAFETY_CHECK
PROC
LLWEAPONEX_VenchingMachine_Internal_RunSafetyCheck((CHARACTERGUID)_VendingMachine, (STRING)_Level, 1)
AND
DB_LeaderLib_Traders_Active(_VendingMachine, _TraderID, _OtherLevel)
AND
ObjectIsOnStage(_VendingMachine, 0)
AND
DB_CurrentLevel(_Level)
THEN
LeaderLog_Log("DEBUG", "[LLWEAPONEX_01_VendingMachine:Internal:RunSafetyCheck] Vending Machine isn't on stage, but it is an activate trader! Hopefully fixing.");
NOT DB_LeaderLib_Traders_Active(_VendingMachine, _TraderID, _OtherLevel);
LeaderLib_Traders_Internal_TeleportToPosition(_TraderID, _Level, _VendingMachine);
SetOnStage(_VendingMachine, 1);
ProcObjectTimer(_VendingMachine, "LLWEAPONEX_Timers_CheckVendingMachinePosition", 2000);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_VendingMachine, "LLWEAPONEX_Timers_CheckVendingMachinePosition")
AND
NOT DB_LeaderLib_Traders_Active(_VendingMachine, _, _)
AND
DB_CurrentLevel(_Level)
AND
DB_LeaderLib_Traders_LevelPosition("LLWEAPONEX.VendingMachine", _Level, _x, _y, _z)
THEN
LeaderLog_Log("DEBUG", "[LeaderLib:LeaderTrader] [ERROR] LeaderTrader was unable to spawn via [LeaderLib_Traders_Internal_CreateTrader]! Attempting to teleport to position manually.");
LeaderLog_Log("DEBUG", "[LLWEAPONEX_01_VendingMachine:LLWEAPONEX_Timers_CheckVendingMachinePosition] VendingMachine was unable to spawn via [LeaderLib_Traders_Internal_CreateTrader]! Attempting to teleport to position manually.");
TeleportToPosition(_VendingMachine, _x, _y, _z, "LeaderLib_Events_OnTraderTeleported", 0);
DB_LeaderLib_Traders_Active(_VendingMachine, "LLWEAPONEX.VendingMachine", _Level);
//END_REGION

//REGION SETTINGS_ORDER_MENU
PROC
LLWEAPONEX_VendingMachine_RegisterOrderMenu()
THEN
//Vending Machine Order Menu
LeaderLib_DynamicMenu_Register_Menu("LLWEAPONEX.VendingMachine.OrderMenu", 8);
LeaderLib_DynamicMenu_Register_Dialog("LLWEAPONEX.VendingMachine.OrderMenu", "LLWEAPONEX_VendingMachine_OrderMenu");
LeaderLib_DynamicMenu_Register_PageFlags("LLWEAPONEX.VendingMachine.OrderMenu", "LLWEAPONEX_VendingMachine_HasMultiplePages", "LLWEAPONEX_VendingMachine_NextPage", "LLWEAPONEX_VendingMachine_PreviousPage", "LLWEAPONEX_VendingMachine_FirstPage", "LLWEAPONEX_VendingMachine_LastPage");

LeaderLib_DynamicMenu_Register_Variable("LLWEAPONEX.VendingMachine.OrderMenu", "LLWEAPONEX_VendingMachine_OrderOption1_01202c05-bdbb-42c2-9cda-8346962041d5", "LLWEAPONEX_VendingMachine_Option1Available", "LLWEAPONEX_VendingMachine_OrderOption1"); 
LeaderLib_DynamicMenu_Register_Variable("LLWEAPONEX.VendingMachine.OrderMenu", "LLWEAPONEX_VendingMachine_OrderOption2_1af35687-3367-4206-8aa4-debee4b81d92", "LLWEAPONEX_VendingMachine_Option2Available", "LLWEAPONEX_VendingMachine_OrderOption2"); 
LeaderLib_DynamicMenu_Register_Variable("LLWEAPONEX.VendingMachine.OrderMenu", "LLWEAPONEX_VendingMachine_OrderOption3_048eaa1b-d937-48bb-ac2c-5759cd64540f", "LLWEAPONEX_VendingMachine_Option3Available", "LLWEAPONEX_VendingMachine_OrderOption3"); 
LeaderLib_DynamicMenu_Register_Variable("LLWEAPONEX.VendingMachine.OrderMenu", "LLWEAPONEX_VendingMachine_OrderOption4_33af56c3-1b27-4867-9f71-ec84fc3a2fb4", "LLWEAPONEX_VendingMachine_Option4Available", "LLWEAPONEX_VendingMachine_OrderOption4"); 
LeaderLib_DynamicMenu_Register_Variable("LLWEAPONEX.VendingMachine.OrderMenu", "LLWEAPONEX_VendingMachine_OrderOption5_6304637d-2828-45ec-b01d-d4769787a29b", "LLWEAPONEX_VendingMachine_Option5Available", "LLWEAPONEX_VendingMachine_OrderOption5"); 
LeaderLib_DynamicMenu_Register_Variable("LLWEAPONEX.VendingMachine.OrderMenu", "LLWEAPONEX_VendingMachine_OrderOption6_d70c702c-a0c1-49a7-8772-1479725e2a39", "LLWEAPONEX_VendingMachine_Option6Available", "LLWEAPONEX_VendingMachine_OrderOption6"); 
LeaderLib_DynamicMenu_Register_Variable("LLWEAPONEX.VendingMachine.OrderMenu", "LLWEAPONEX_VendingMachine_OrderOption7_5027bce6-f787-4977-a23c-a09175f02508", "LLWEAPONEX_VendingMachine_Option7Available", "LLWEAPONEX_VendingMachine_OrderOption7"); 
LeaderLib_DynamicMenu_Register_Variable("LLWEAPONEX.VendingMachine.OrderMenu", "LLWEAPONEX_VendingMachine_OrderOption8_643f5348-d324-4508-ace3-71505bb30dee", "LLWEAPONEX_VendingMachine_Option8Available", "LLWEAPONEX_VendingMachine_OrderOption8");

LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderAccessory", "*[ACCESSORY] Click on the button labeled 'Accessory'.*", "h9c7f3144g17d0g40b0gab03g29ca403e0291");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderArmor", "*[ANY ARMOR] Click on the button labeled 'Any Armor'.*", "hf2f3f5dfg801eg4b17ga5d6g59c975b1c065");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderClothArmor", "*[CLOTH ARMOR] Click on the button labeled 'Cloth Armor'.*", "hfb6a8f97g3ff7g4546gb956gfebacf97fef3");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderHeavyArmor", "*[HEAVY ARMOR] Click on the button labeled 'Heavy Armor'.*", "h30ecfbc9gae81g4f70g84d6ge44e9e14e9a6");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderLightArmor", "*[LIGHT ARMOR] Click on the button labeled 'Light Armor'.*", "hdd97747cgef6cg42b9gaa6age60edc02d4d5");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderMageArmor", "*[MAGE ARMOR] Click on the button labeled 'Mage Armor'.*", "hfcd7afbagcf8bg49cdg90ffg27193e3bf9ca");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderWeapon", "*[ANY WEAPON] Click on the button labeled 'Any Weapon'.*", "hdcbe8f3eg3960g49b2g8f63ged3336519e25");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderOneHandedWeapon", "*[ONE-HANDED] Click on the button labeled 'One-Handed'.*", "h41ff62e4g3ae2g4f24ga725g0442f8e936a2");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderTwoHandedWeapon", "*[TWO-HANDED] Click on the button labeled 'Two-Handed'.*", "h4746d357ge878g462eg86ccg30f7a8115f17");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderRangedWeapon", "*[RANGED] Click on the button labeled 'Ranged'.*", "h0991fa6cgdc68g410dgbc3cg0c6a36fe8d8b");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderStaff", "*[STAFFS] Click on the button labeled 'Staffs'.*", "h1599bddcg8b04g4ed6gbb4dg88f0196afca4");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderWand", "*[WANDS] Click on the button labeled 'Wands'.*", "h673b26f0g9e0ag45d3g857fg353aa68f1086");
//LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_Trader_WeaponArcher", "*[ARCHER WEAPON] Click on the button labeled 'Archer Weapons'.*", "h78010912gec24g495ega080gedc162aa057a");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderRogueWeapon", "*[ROGUE WEAPONS] Click on the button labeled 'Rogue Weapons'.*", "hd27567f7g04adg40a3gb780g1fd98acbbc57");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderWarriorWeapon", "*[WARRIOR WEAPONS] Click on the button labeled 'Warrior Weapons'.*", "hdcacc003g3fa3g4e51g934cg7fc60b3ba861");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_LLWEAPONEX_VendingMachine_OrderWizardWeapon", "*[WIZARD WEAPONS] Click on the button labeled 'Wizard Weapons'.*", "h03451e09g2f0bg410eg89cdg1d80b656605c");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_AllPotions", "*[POTIONS] Click on the button labeled 'Potions'.*", "h9b0a4bf7gbdb6g4c86g8f40ga7f59d86e44f");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_AllPotionsSpecial", "*[S. POTIONS] Click on the button labeled 'Special Potions'.*", "h19f981b6ga410g4989g81eeg51addefc629f");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_Ingredients", "*[INGREDIENTS] Click on the button labeled 'Ingredients'.*", "h57a85f45gfe1cg4b47ga0f9g51dcaeb29d0a");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_Grenades", "*[GRENADES] Click on the button labeled 'Grenades'.*", "h72c0eff2g75e3g43f6gbd70g395c6d2d1e95");
LLWEAPONEX_VendingMachine_AddOrderToMenu("ST_Arrows", "*[ARROWS] Click on the button labeled 'Arrows'.*", "h70dc0b03g8391g4151gaccfg8146c87b203e");

PROC
LLWEAPONEX_VendingMachine_AddOrderToMenu((STRING)_TreasureTable, (STRING)_EntryText, (STRING)_Handle)
THEN
LeaderLib_DynamicMenu_Register_TranslatedStringEntry("LLWEAPONEX.VendingMachine.OrderMenu", _TreasureTable, _Handle, _EntryText);
//END_REGION

//REGION ORDER_MENU
/*
IF
DialogStarted("LLWEAPONEX_VendingMachine_OrderMenu", _Instance)
THEN
LeaderLib_DynamicMenu_InitMenu("LLWEAPONEX.VendingMachine.OrderMenu", _Instance);
*/

PROC
LeaderLib_DynamicMenu_OnEntryValueSet((GUIDSTRING)_Player, "LLWEAPONEX.VendingMachine.OrderMenu", (STRING)_DialogVar, (STRING)_AvailableFlag, (INTEGER)_Instance, (STRING)_TreasureTable, (STRING)_DisplayText)
AND
DB_LLWEAPONEX_VendingMachine_LastOrdered(_TreasureTable, _LastInstance)
THEN
ObjectClearFlag(_Player, _AvailableFlag, _Instance);

PROC
LeaderLib_DynamicMenu_OnEntrySelected("LLWEAPONEX.VendingMachine.OrderMenu", (GUIDSTRING)_Player, (INTEGER)_Instance, (STRING)_TreasureTable)
THEN
LeaderLog_Log("DEBUG", "[LLWEAPONEX:VendingMachine:OnEntrySelected] Entry [",_TreasureTable,"] was selected.");
LLWEAPONEX_VendingMachine_OrderTreasure(_Player, _TreasureTable, _Instance);

PROC
LLWEAPONEX_VendingMachine_OrderTreasure((GUIDSTRING)_Player, (STRING)_TreasureTable, (INTEGER)_Instance)
AND
NOT DB_LLWEAPONEX_VendingMachine_LastOrdered(_TreasureTable, _)
THEN
LeaderLog_Log("DEBUG", "[LLWEAPONEX:VendingMachine:OrderTreasure] Setting next order to [",_TreasureTable,"].");
DB_LLWEAPONEX_VendingMachine_NextOrder(_TreasureTable, _Instance);
ObjectSetFlag(_Player, "LLWEAPONEX_VendingMachine_OrderChosen", _Instance);

IF
ObjectFlagSet("LLWEAPONEX_VendingMachine_CompleteOrder", _Player, _Instance)
AND
DB_LLWEAPONEX_VendingMachine_LastOrdered(_LastTreasureTable, _LastInstance)
THEN
NOT DB_LLWEAPONEX_VendingMachine_LastOrdered(_LastTreasureTable, _LastInstance);

IF
ObjectFlagSet("LLWEAPONEX_VendingMachine_CompleteOrder", _Player, _Instance)
AND
LeaderLib_Helper_QRY_ClearObjectFlag(_Player, "LLWEAPONEX_VendingMachine_CompleteOrder")
AND
DB_LLWEAPONEX_VendingMachine_NextOrder(_TreasureTable, _Instance)
AND
DialogGetInvolvedNPC(_Instance, 1, _VendingMachine)
THEN
SysClear("DB_LLWEAPONEX_VendingMachine_NextOrder", 2);
SysClear("DB_LLWEAPONEX_VendingMachine_LastOrdered", 2);
DB_LLWEAPONEX_VendingMachine_LastOrdered(_TreasureTable, _Instance);
DB_LLWEAPONEX_VendingMachine_GenerateNext(_TreasureTable);
ObjectSetFlag(_VendingMachine, "LLWEAPONEX_VendingMachine_OrderMenuDisabled", 0);

IF
TradeGenerationStarted(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a)
AND
DB_LLWEAPONEX_VendingMachine_GenerateNext(_TreasureTable)
THEN
NOT DB_LLWEAPONEX_VendingMachine_GenerateNext(_TreasureTable);
NRD_ModCall("WeaponExpansion", "GenerateTradeTreasure", "680d2702-721c-412d-b083-4f5e816b945a", _TreasureTable);
SetStoryEvent(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_VendingMachine_OnOrderGenerated");

IF
DialogEnded("LLWEAPONEX_VendingMachine_OrderMenu", _Instance)
AND
DialogGetInvolvedPlayer(_Instance, 1, _Player)
THEN
ObjectClearFlag(_Player, "LLWEAPONEX_VendingMachine_OrderChosen", _Instance);
ObjectClearFlag(_Player, "LLWEAPONEX_VendingMachine_CompleteOrder", _Instance);

IF
StoryEvent(_VendingMachine, "LLWEAPONEX_VendingMachine_OnOrderGenerated")
THEN
ObjectClearFlag(_VendingMachine, "LLWEAPONEX_VendingMachine_OrderMenuDisabled", 0);
LeaderLog_Log("DEBUG", "[LLWEAPONEX:VendingMachine:OnOrderGenerated] Treasure order complete. Cleared flag 'LLWEAPONEX_VendingMachine_OrderMenuDisabled'.");
PlayEffect(_VendingMachine, "LLWEAPONEX_FX_VendingMachine_Words_OrderArrived_01", "Dummy_OverheadFX");
//END_REGION

//REGION INIT
IF
CharacterLeveledUp(_Player)
AND
DB_IsPlayer(_Player)
THEN
LeaderLib_Timers_StartObjectTimer(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, 250, "Timers_LLWEAPONEX_LevelUpVendingMachine", "LLWEAPONEX_LevelUpVendingMachine");

IF
StoryEvent((CHARACTERGUID)_Char, "LLWEAPONEX_LevelUpVendingMachine")
AND
LeaderLib_Helper_QRY_GetHighestPlayerLevel()
AND
DB_LeaderLib_Helper_Temp_HighestPlayerLevel(_Level)
THEN
CharacterLevelUpTo(_Char, _Level);

IF
CharacterLeveledUp(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a)
THEN
TimerCancel("LLWEAPONEX_Timers_VendingMachine_LevelUpItems");
TimerLaunch("LLWEAPONEX_Timers_VendingMachine_LevelUpItems", 500);

IF
TimerFinished("LLWEAPONEX_Timers_VendingMachine_LevelUpItems")
THEN
InventoryLaunchTagIterator(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LeaderLib_AutoLevel", "", "LLWEAPONEX_VendingMachine_Iterator_LevelUpItem", "");

IF
StoryEvent((ITEMGUID)_Item, "LLWEAPONEX_VendingMachine_Iterator_LevelUpItem")
THEN
LeaderLib_Growth_Items_LevelUpItem(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _Item);

IF
TextEventSet("llweap_addtokens")
THEN
CharacterGiveReward(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "ST_LLWEAPONEX_VendingMachine_AttributeTokens_Start");

PROC
LeaderLib_Traders_OnSpawned(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, (STRING)_TraderID, (STRING)_Region)
AND
ObjectGetFlag(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_Vending_Initialized", 0)
THEN
LeaderLog_Log("DEBUG", "[LLWEAPONEX:VendingMachine:OnSpawned] Initializing Vending Machine.");
ProcObjectTimer(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_Timers_LevelUpVendingMachine", 1000);
PROC_LoopEffect("LLWEAPONEX_VendingMachine_WeaponDisplay_Quarterstaff_01", S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_FX_VendingMachine_WeaponDisplay_Hook", _Region, "Dummy_WeaponDisplay_Hook");
PROC_LoopEffect("LLWEAPONEX_VendingMachine_WeaponDisplay_ThrowingWeapons_01", S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_FX_VendingMachine_WeaponDisplay_Bottom", _Region, "Dummy_WeaponDisplay_Bottom");
ObjectSetFlag(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_Vending_Initialized", 0);
//LLWEAPONEX_VendingMachine_Internal_SaveItems(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a);
//CharacterTransformAppearanceToWithEquipmentSet(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_VendingMachine_A", 0);

//Flipped bones workaround for now
//PROC_StopLoopEffect(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_VendingMachineWorkaroundDisplay");
//PROC_LoopEffect("LLWEAPONEX_FX_VendingMachine_MachineDisplay_Debug_01", S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_VendingMachineWorkaroundDisplay", _Region, "");

//Initial Trade Items, should happen AFTER initial treasure is generated so the items don't get deleted by the game :(
PROC
ProcGenerateTradeTreasure((CHARACTERGUID)_Player, (CHARACTERGUID)S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a)
AND
ObjectGetFlag(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_Vending_InitialItemsGenerated", 0)
THEN
//CharacterGiveReward(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "ST_LLWEAPONEX_VendingMachine_AttributeTokens_Start");
ObjectSetFlag(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_Vending_InitialItemsGenerated", 0);
ItemTemplateAddTo("LLWEAPONEX_TradeBag_AttributeTokens_Initial_39696124-ca27-4c76-860e-29aec727b5a7", S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, 1, 0);

IF
ItemTemplateAddedToCharacter(LLWEAPONEX_TradeBag_AttributeTokens_Initial_39696124-ca27-4c76-860e-29aec727b5a7, _Pouch, _Player)
AND
DB_IsPlayer(_Player)
THEN
Transform(_Pouch, "LLWEAPONEX_TradeBag_AttributeTokens_c8b9b34d-a1a8-446e-993f-ff5c1338bc8a", 1, 1);
GenerateTreasure(_Pouch, "ST_LLWEAPONEX_VendingMachine_AttributeTokens_Start", -1, _Player);

QRY
LLWEAPONEX_VendingMachine_QRY_IsInside("LV_HoE_Main")
THEN
DB_NOOP(1);

QRY
LLWEAPONEX_VendingMachine_QRY_IsInside("RC_Main")
THEN
DB_NOOP(1);

QRY
LLWEAPONEX_VendingMachine_QRY_IsInside("CoS_Main")
THEN
DB_NOOP(1);

QRY
LLWEAPONEX_VendingMachine_QRY_IsInside("TestLevel_LL_WeaponExpansion")
THEN
DB_NOOP(1);

IF
ObjectFlagSet("LLWEAPONEX_Vending_Initialized", (CHARACTERGUID)_VendingMachine, _)
AND
DB_CurrentLevel(_Region)
AND
NOT LLWEAPONEX_VendingMachine_QRY_IsInside(_Region)
THEN
PROC_LoopEffect("LLWEAPONEX_VendingMachine_A_PipeSmoke_01", _VendingMachine, "LLWEAPONEX_FX_VendingMachine_Smoke", _Region, "Dummy_SmokeFX");

IF
ObjectFlagSet("LLWEAPONEX_Vending_Initialized", (CHARACTERGUID)_VendingMachine, _)
AND
DB_CurrentLevel(_Region)
AND
LLWEAPONEX_VendingMachine_QRY_IsInside(_Region)
THEN
PROC_LoopEffect("LLWEAPONEX_VendingMachine_A_PipeSmoke_02", _VendingMachine, "LLWEAPONEX_FX_VendingMachine_Smoke", _Region, "Dummy_SmokeFX");

PROC
ProcObjectTimerFinished((CHARACTERGUID)_VendingMachine, "LLWEAPONEX_Timers_LevelUpVendingMachine")
AND
CharacterGetHostCharacter(_Player)
AND
CharacterGetLevel(_Player, _Level)
THEN
CharacterLevelUpTo(_VendingMachine, _Level);

//Temporary workaround
/*
IF
GameStarted(_Region, _)
AND
ObjectExists(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, 1)
AND
HasActiveStatus(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LEADERLIB_NO_VISUAL", 0)
THEN
ApplyStatus(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LEADERLIB_NO_VISUAL", -1.0);
*/
//END_REGION

//REGION SALE_EFFECT
IF
DialogStarted("LLWEAPONEX_VendingMachine_A", _)
AND
ObjectGetFlag(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_VendingMachine_SaleActive", 1)
AND
ObjectGetFlag(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_VendingMachine_PlayedSaleEffect", 0)
THEN
PlayEffect(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_FX_VendingMachine_Words_Sale_01", "Dummy_OverheadFX");
ObjectSetFlag(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_VendingMachine_PlayedSaleEffect", 0);

PROC
LLWEAPONEX_VendingMachine_OnSaleEnded((CHARACTERGUID)_VendingMachine)
THEN
LeaderLog_Log("DEBUG", "[LLWEAPONEX:VendingMachine:TradeGenerationEnded] Sale ended.");
LLWEAPONEX_VendingMachine_ResetSaleAttitude();
DialogSetVariableString("LLWEAPONEX_VendingMachine_A", "LLWEAPONEX_VendingMachine_SaleStatus_b12f911c-7a98-4ff1-a35c-f2127335884f", "");
ObjectClearFlag(_VendingMachine, "LLWEAPONEX_VendingMachine_PlayedSaleEffect", 0);
ObjectClearFlag(_VendingMachine, "LLWEAPONEX_VendingMachine_SaleActive", 0);
//END_REGION

//REGION SALES
IF
TradeGenerationEnded(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a)
THEN
LLWEAPONEX_VendingMachine_OnTradeGenerationEnded(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a);

PROC
LLWEAPONEX_VendingMachine_OnTradeGenerationEnded((CHARACTERGUID)_VendingMachine)
AND
NOT DB_LLWEAPONEX_VendingMachine_Temp_GenerationTickDone(_)
AND
NOT DB_LLWEAPONEX_VendingMachine_SaleCooldown(_,_)
AND
LeaderLib_Roll_QRY(599)
AND
LeaderLib_Random_QRY(5)
AND
DB_LeaderLib_Random(_CooldownTimeRan)
AND
IntegerSum(_CooldownTimeRan, 1, _CooldownTime)
AND
LeaderLib_Random_QRY(1)
AND
DB_LeaderLib_Random(_ActiveTimeRan)
AND
IntegerSum(1, _ActiveTimeRan, _ActiveTime)
AND
IntegertoString(_ActiveTime, _ActiveTimeStr)
AND
IntegertoString(_CooldownTime, _CooldownTimeStr)
THEN
NOT DB_LeaderLib_Random(_ActiveTimeRan);
LeaderLog_Log("DEBUG", "[LLWEAPONEX:VendingMachine:TradeGenerationEnded] The vending machine started a sale for [",_ActiveTimeStr,"] generation events. Cooldown: [",_CooldownTimeStr,"]");
DialogSetVariableString("LLWEAPONEX_VendingMachine_A", "LLWEAPONEX_VendingMachine_SaleStatus_b12f911c-7a98-4ff1-a35c-f2127335884f", " You see a sign that reads: 'Limited time sale now active!'");
ObjectSetFlag(_VendingMachine, "LLWEAPONEX_VendingMachine_SaleActive", 0);
DB_LLWEAPONEX_VendingMachine_SaleCooldown(_ActiveTime, _CooldownTime);
DB_LLWEAPONEX_VendingMachine_Temp_SaleStarted(1);
DB_LLWEAPONEX_VendingMachine_Temp_GenerationTickDone(1);
ProcObjectTimer(_VendingMachine, "LLWEAPONEX_Timers_VendingMachine_SaleStarted", 1000);

IF
DB_LLWEAPONEX_VendingMachine_Temp_SaleStarted(1)
AND
DB_IsPlayer(_Player)
THEN
CharacterAddAttitudeTowardsPlayer(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _Player, 100);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_VendingMachine, "LLWEAPONEX_Timers_VendingMachine_SaleStarted")
AND
DB_LLWEAPONEX_VendingMachine_Temp_SaleStarted(1)
THEN
NOT DB_LLWEAPONEX_VendingMachine_Temp_SaleStarted(1);

//Sale countdown
PROC
LLWEAPONEX_VendingMachine_OnTradeGenerationEnded((CHARACTERGUID)_VendingMachine)
AND
NOT DB_LLWEAPONEX_VendingMachine_Temp_GenerationTickDone(_)
AND
NOT DB_LLWEAPONEX_VendingMachine_Temp_SaleJustDecreased(_)
AND
DB_LLWEAPONEX_VendingMachine_SaleCooldown(_ActiveTime, _CooldownTime)
AND
_ActiveTime > 0
AND
IntegerSubtract(_ActiveTime, 1, _NextActiveTime)
AND
IntegertoString(_NextActiveTime, _NextActiveTimeStr)
THEN
LeaderLog_Log("DEBUG", "[LLWEAPONEX:VendingMachine:TradeGenerationEnded] Sale time decreased. Remaining events: [",_NextActiveTimeStr,"]");
NOT DB_LLWEAPONEX_VendingMachine_SaleCooldown(_ActiveTime, _CooldownTime);
DB_LLWEAPONEX_VendingMachine_SaleCooldown(_NextActiveTime, _CooldownTime);
DB_LLWEAPONEX_VendingMachine_Temp_SaleJustDecreased(1);
DB_LLWEAPONEX_VendingMachine_Temp_GenerationTickDone(1);
ProcObjectTimer(_VendingMachine, "LLWEAPONEX_Timers_VendingMachine_ResetSaleDecreased", 10000);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_VendingMachine, "LLWEAPONEX_Timers_VendingMachine_ResetSaleDecreased")
AND
DB_LLWEAPONEX_VendingMachine_Temp_SaleJustDecreased(1)
THEN
NOT DB_LLWEAPONEX_VendingMachine_Temp_SaleJustDecreased(1);

//Sale Over
PROC
LLWEAPONEX_VendingMachine_OnTradeGenerationEnded((CHARACTERGUID)_VendingMachine)
AND
NOT DB_LLWEAPONEX_VendingMachine_Temp_GenerationTickDone(_)
AND
DB_LLWEAPONEX_VendingMachine_SaleCooldown(_ActiveTime, _CooldownTime)
AND
_ActiveTime == 0
THEN
NOT DB_LLWEAPONEX_VendingMachine_SaleCooldown(_ActiveTime, _CooldownTime);
DB_LLWEAPONEX_VendingMachine_SaleCooldown(-1, _CooldownTime);
DB_LLWEAPONEX_VendingMachine_Temp_GenerationTickDone(1);
LLWEAPONEX_VendingMachine_OnSaleEnded(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a);

PROC
LLWEAPONEX_VendingMachine_OnTradeGenerationEnded((CHARACTERGUID)_VendingMachine)
AND
NOT DB_LLWEAPONEX_VendingMachine_Temp_GenerationTickDone(_)
AND
NOT DB_LLWEAPONEX_VendingMachine_Temp_SaleStarted(1)
AND
DB_LLWEAPONEX_VendingMachine_SaleCooldown(-1, _CooldownTime)
AND
_CooldownTime > 0
THEN
LLWEAPONEX_VendingMachine_DecrementSaleCooldown();
DB_LLWEAPONEX_VendingMachine_Temp_GenerationTickDone(1);

PROC
LLWEAPONEX_VendingMachine_OnTradeGenerationEnded((CHARACTERGUID)_VendingMachine)
AND
DB_LLWEAPONEX_VendingMachine_Temp_GenerationTickDone(_Var)
THEN
NOT DB_LLWEAPONEX_VendingMachine_Temp_GenerationTickDone(_Var);

PROC
LLWEAPONEX_VendingMachine_DecrementSaleCooldown()
AND
DB_LLWEAPONEX_VendingMachine_SaleCooldown(-1, _CooldownTime)
AND
IntegerSubtract(_CooldownTime, 1, _NextCooldownTime)
THEN
NOT DB_LLWEAPONEX_VendingMachine_SaleCooldown(-1, _CooldownTime);
DB_LLWEAPONEX_VendingMachine_SaleCooldown(-1, _NextCooldownTime);

IF
DB_LLWEAPONEX_VendingMachine_SaleCooldown(-1, _CooldownTime)
AND
_CooldownTime <= 0
THEN
LLWEAPONEX_VendingMachine_ClearSaleCooldown();

PROC
LLWEAPONEX_VendingMachine_ClearSaleCooldown()
AND
DB_LLWEAPONEX_VendingMachine_SaleCooldown(_Active, _CooldownTime)
THEN
NOT DB_LLWEAPONEX_VendingMachine_SaleCooldown(_Active, _CooldownTime);

PROC
LLWEAPONEX_VendingMachine_ClearSaleCooldown()
AND
DB_LLWEAPONEX_VendingMachine_Temp_SaleStarted(1)
THEN
NOT DB_LLWEAPONEX_VendingMachine_Temp_SaleStarted(1);

PROC
LLWEAPONEX_VendingMachine_ClearSaleCooldown()
AND
DB_LLWEAPONEX_VendingMachine_Temp_SaleJustDecreased(1)
THEN
NOT DB_LLWEAPONEX_VendingMachine_Temp_SaleJustDecreased(1);

PROC
LLWEAPONEX_VendingMachine_ResetSaleAttitude()
AND
DB_IsPlayer(_Player)
AND
CharacterGetAttitudeTowardsPlayer(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _Player, _Attitude)
AND
_Attitude > 0
AND
IntegerProduct(_Attitude, -1, _RemoveAmount)
THEN
CharacterAddAttitudeTowardsPlayer(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _Player, _RemoveAmount);

IF
CharacterAttitudeTowardsPlayerChanged(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _Player, _NewAttitude)
AND
_NewAttitude < 0
AND
IntegerProduct(_NewAttitude, -1, _AddAmount)
THEN
CharacterAddAttitudeTowardsPlayer(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _Player, _AddAmount);

//Prevent "bribing" a machine
IF
DB_AttitudeAdjustMent(_Player, S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _Att)
AND
_Att != 0
THEN
NOT DB_AttitudeAdjustMent(_Player, S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _Att);
DB_AttitudeAdjustMent(_Player, S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, 0);

//Prevent "insulting" a machine
IF
DB_InsultCounter(_Player, S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _InsultCount)
AND
_InsultCount > 0
THEN
NOT DB_InsultCounter(_Player, S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _InsultCount);
DB_InsultCounter(_Player, S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, 0);
//END_REGION

//REGION RESET

IF
RegionEnded(_)
AND
ObjectExists(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, 1)
THEN
ObjectClearFlag(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "LLWEAPONEX_Vending_Initialized");

IF
ObjectFlagCleared("LLWEAPONEX_Vending_Initialized", S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _)
THEN
LLWEAPONEX_VendingMachine_ClearSaleCooldown();

/*
IF
StoryEvent(_VendingMachine, "LLWEAPONEX_VendingMachine_StartLoopEffects")
AND
DB_CurrentLevel(_Region)
THEN
PROC_LoopEffect("LLWEAPONEX_VendingMachine_A_PipeSmoke_01", _VendingMachine, "LLWEAPONEX_FX_VendingMachine_Smoke", _Region, "Dummy_SmokeFX");
PROC_LoopEffect("LLWEAPONEX_VendingMachine_WeaponDisplay_Quarterstaff_01", _VendingMachine, "LLWEAPONEX_FX_VendingMachine_WeaponDisplay_Hook", _Region, "Dummy_WeaponDisplay_Hook");
PROC_LoopEffect("LLWEAPONEX_VendingMachine_WeaponDisplay_ThrowingWeapons_01", _VendingMachine, "LLWEAPONEX_FX_VendingMachine_WeaponDisplay_Bottom", _Region, "Dummy_WeaponDisplay_Bottom");
LeaderLog_Log("DEBUG", "[LLWEAPONEX:VendingMachine:StartLoopEffects] Starting looped effects on vending machine.");
*/

//END_REGION

//REGION ANIMATIONS
IF
TextEventSet("llweap_vendtop")
THEN
CharacterUseSkill(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "Shout_LLWEAPONEX_VendingMachine_Move_Top", S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a,1,1,1);

IF
CharacterUsedSkill(_VendingMachine, "Shout_LLWEAPONEX_VendingMachine_Move_Top", _, _)
AND
DB_CurrentLevel(_Level)
THEN
//PROC_LoopBeamEffect((STRING)_effect, (GUIDSTRING)_Source,(GUIDSTRING)_Target,(STRING)_SrcBone,(STRING)_TargetBone,(STRING)_ID,(STRING)_Region)
PROC_LoopBeamEffect("RS3_FX_GP_Beams_Telekinesis_01", _VendingMachine, _VendingMachine, "Dummy_BeamFX", "Dummy_WeaponDisplay_Top", "LLWEAPONEX_VendingMachine_TopItemMovement", _Level);

IF
SkillCast(_VendingMachine, "Shout_LLWEAPONEX_VendingMachine_Move_Top", _, _)
THEN
PROC_StopLoopBeamEffect(_VendingMachine, "LLWEAPONEX_VendingMachine_TopItemMovement");

IF
TextEventSet("llweap_vendmiddle")
THEN
CharacterUseSkill(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, "Shout_LLWEAPONEX_VendingMachine_Move_Middle", S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a,1,1,1);

IF
CharacterUsedSkill(_VendingMachine, "Shout_LLWEAPONEX_VendingMachine_Move_Middle", _, _)
AND
DB_CurrentLevel(_Level)
THEN
//PROC_LoopBeamEffect((STRING)_effect, (GUIDSTRING)_Source,(GUIDSTRING)_Target,(STRING)_SrcBone,(STRING)_TargetBone,(STRING)_ID,(STRING)_Region)
PROC_LoopBeamEffect("RS3_FX_GP_Beams_Telekinesis_01", _VendingMachine, _VendingMachine, "Dummy_BeamFX", "Dummy_WeaponDisplay_Top", "LLWEAPONEX_VendingMachine_TopItemMovement", _Level);

IF
SkillCast(_VendingMachine, "Shout_LLWEAPONEX_VendingMachine_Move_Top", _, _)
THEN
PROC_StopLoopBeamEffect(_VendingMachine, "LLWEAPONEX_VendingMachine_TopItemMovement");

IF
TextEventSet("llweap_vendtest")
AND
GetTextEventParamString(1, _Anim)
THEN
PlayAnimation(S_LLWEAPONEX_VendingMachine_A_680d2702-721c-412d-b083-4f5e816b945a, _Anim, "");
//END_REGION

EXITSECTION

ENDEXITSECTION
ParentTargetEdge "LaughingLeader_WeaponExpansion"
